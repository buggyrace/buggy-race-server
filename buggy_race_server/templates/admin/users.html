{% extends "layout.html" %}
{% block content %}
{%include "admin/_nav.html" %}
<div class="container pb-5">
  <div class="row">
    <h1 class="col my-3">
      {%if want_detail %}
         All Users
      {% else %}
         Students
      {% endif %}
    </h1>
  </div>
  {%if want_detail %}
    <div class="row">
      <div class="col">
        <p>
          All {{ users|length }} users in the system.
          {{ qty_students}} are students (&Sopf;),
          {{ qty_admins }} are admins (&starf;),
          {{ qty_teaching_assistants }} teaching assistants (&star;).
        </p>
      </div>
    </div>
    <div class="row my-3" id="user-column-toggles">
      <div class="col">
        <button class="btn btn-outline-secondary btn-sm" data-column="all-columns">All&nbsp;columns</button>
        {% if config['USERS_HAVE_FIRST_NAME'] %}
          <button class="btn btn-outline-secondary btn-sm" data-column="u-first-name">First&nbsp;name</button>
        {% endif %}
        {% if config['USERS_HAVE_LAST_NAME'] %}
          <button class="btn btn-outline-secondary btn-sm" data-column="u-last-name">Last&nbsp;name</button>
        {% endif %}
        {% if config['USERS_HAVE_EMAIL'] %}
          <button class="btn btn-outline-secondary btn-sm" data-column="u-email">Email</button>
        {% endif %}
        {% if config['USERS_HAVE_EXT_USERNAME'] %}
          <button class="btn btn-outline-secondary btn-sm" data-column="u-org-username">{{ ext_username_name }}</button>
        {% endif %}
        {% if config['USERS_HAVE_EXT_ID'] %}
          <button class="btn btn-outline-secondary btn-sm" data-column="u-ext-id">{{ ext_id_name }}</button>
        {% endif %}
        <button class="btn btn-outline-secondary btn-sm" data-column="u-created-at">Created</button>
        <button class="btn btn-outline-secondary btn-sm" data-column="u-is-active">Active?</button>
        <button class="btn btn-outline-secondary btn-sm" data-column="u-login-at">Last&nbsp;activity</button>
        <button class="btn btn-outline-secondary btn-sm" data-column="u-github">GitHub</button>
        <button class="btn btn-outline-secondary btn-sm" data-column="u-uploaded">Uploaded</button>
      </div>
    </div>
  {% endif %}
  <div class="row">
    <table class="col table table-striped table-bordered table-hover table-responsive bg-white">
      <thead>
        <tr class="sticky-top bg-white">
          {% if current_user_can_edit %}
            <th></th>
          {% endif %}
          <th></th>
          <th class="u-username">Username</th>
          {%if want_detail %}
            {% if config['USERS_HAVE_FIRST_NAME'] %}
              <th class="u-first-name">Name</th>
            {% endif %}
            {% if config['USERS_HAVE_LAST_NAME'] %}
              <th class="u-last-name">Last name</th>
            {% endif %}
            {% if config['USERS_HAVE_EMAIL'] %}
              <th class="u-email">Email</th>
            {% endif %}
            {% if config['USERS_HAVE_EXT_USERNAME'] %}
              <th  class="u-org-username">{{ ext_username_name | title }}</th>
            {% endif %}
            {% if config['USERS_HAVE_EXT_ID'] %}
              <th  class="u-ext-id">{{ ext_id_name | title }}</th>
            {% endif %}
            <th  class="u-created-at">Created</th>
            <th  class="u-is-active">Active?</th>
          {% endif %}
          <th class="u-login-at">Last activity at</th>
          <th class="u-github">GitHub (&rarr; repo)</th>
          <th colspan="2" class="u-uploaded">JSON uploaded</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          {% if qty_students > 0 %}
            {% if current_user_can_edit %}
              <td></td>
            {% endif %}
            <td></td>
            <td class="u-username"></td>
            {%if want_detail %}
              {% if config['USERS_HAVE_FIRST_NAME'] %}
                <td class="u-first-name"></td>
              {% endif %}
              {% if config['USERS_HAVE_LAST_NAME'] %}
                <td class="u-last-name"></td>
              {% endif %}
              {% if config['USERS_HAVE_EMAIL'] %}
                <td class="u-email"></td>
              {% endif %}
              {% if config['USERS_HAVE_EXT_USERNAME'] %}
                <td class="u-org-username"></td>
              {% endif %}
              {% if config['USERS_HAVE_EXT_ID'] %}
                <td class="u-ext-id"></td>
              {% endif %}
              <td class="u-created-at"></td>
              <td class="u-is-active">{{ qty_students_enabled }}   ({{ "%d" | format(100 * qty_students_enabled/qty_students) }}%) </td>
            {% endif %}
            <td class="u-login-at">{{ qty_students_logged_in }}   ({{ "%d" | format(100 * qty_students_logged_in/qty_students) }}%)</td>
            <td class="u-github">{{ qty_students_github }}   ({{ "%d" | format(100 * qty_students_github/qty_students) }}%)</td>
            <td colspan="2" class="u-uploaded">{{ qty_students_uploaded_json }} ({{ "%d" | format(100 * qty_students_uploaded_json/qty_students) }}%)</td>
          {% else %}
            <td colspan="9">No users enrolled as students</td>
          {% endif %}
        </tr>
        {% for u in users %}
          {% if want_detail or u.is_student %}
            <tr {% if u.is_staff %}class="staff" {% endif %}>
              {% if current_user_can_edit %}
                <td class="bool-{{ u.is_active | lower }}">
                  <a class="btn btn-outline-secondary btn-admin btn-sm btn-jump" href="{{ url_for(edit_method, user_id=u.id) }}">Edit</a>
                </td>
              {% endif %}
              <td style="width:1em">
                <span>{% if u.is_student %}&Sopf;{% endif %}{% if u.is_administrator %}&starf;{% elif u.is_teaching_assistant %}&star;{% endif %}</span>
              </td>
              <td class="u-username">
                <a class="sm-item-link" href="{{ url_for('admin.show_user', user_id=u.id) }}">{{ u.pretty_username }}</a>
                {% if u.comment %}
                 <a class="show-comment btn btn-outline-secondary btn-admin btn-sm p-1 ml-1 float-right" href="#"
                   data-comment="{{ u.comment|replace('"', '\\"')|replace("\\n", "\\n") }}"
                   onclick='alert(this.dataset.comment.replace(/\\\"/g,"\""))'
                 >&#x2731;</a>
                {% endif %}
              </td>
              {%if want_detail %}
                {% if config['USERS_HAVE_FIRST_NAME'] %}
                  <td class="u-first-name">{{ u.first_name if u.first_name is not none}}</td>
                {% endif %}
                {% if config['USERS_HAVE_LAST_NAME'] %}
                  <td class="u-last-name">{{ u.last_name if u.last_name is not none}}</td>
                {% endif %}
                {% if config['USERS_HAVE_EMAIL'] %}
                  <td class="u-email">  {{ u.email if u.email is not none }} </td>
                {% endif %}
                {% if config['USERS_HAVE_EXT_USERNAME'] %}
                  <td class="u-org-username">{% if u.ext_username is not none %}<code>{{ u.ext_username }}</code>{% endif %}</td>
                {% endif %}
                {% if config['USERS_HAVE_EXT_ID'] %}
                  <td class="u-ext-id">{% if u.ext_id is not none %}<code>{{ u.ext_id }}</code>{% endif %}</td>
                {% endif %}
                <td class="u-created-at">
                    {% if u.created_at %}
                      {{ u.created_at | servertime }}
                    {% else %}
                    <em class="empty-setting">none</em>
                    {% endif %}
                </td>
                <td class="bool-{{ u.is_active | lower }} u-is-active">
                  {% if u.is_active %}
                    Yes
                  {% else %}
                    No
                  {% endif %}
                </td>
              {% endif %}
              <td class="u-login-at">
                {% if u.logged_in_at %}
                  {{ u.logged_in_at | servertime }}
                {% else %}
                  <em class="empty-setting">none</em>
                {% endif %}
              </td>
              <td class="u-github">  
                {% if u.github_username %}
                  <a href="https://github.com/{{ u.github_username }}" title="GitHub account"><code>{{u.github_username}}</code></a>
                  <a href="https://github.com/{{ u.github_username }}/{{ editor_repo_name }}" title="buggy repo"
                  class="btn btn-outline-secondary btn-white btn-sm btn-jump ml-1 float-right">Repo</a>
                {% endif %}
              </td>
              <td class="bool-{{ u.latest_json|length is greaterthan 1 | lower }} u-uploaded"> 
                {% if u.latest_json|length is greaterthan 1 %}
                  <span  data-username='{{ u.username  | replace("-","_") }}' class="json-btn icon-wrench p-2">
                   {{ u.latest_json|length }}
                  </span>
                {% else %}
                  <em class="empty-setting">none</em>
                {% endif %}
                <!-- not showing buggy link
                <a class="show-comment btn btn-outline-secondary btn-admin btn-sm btn-jump p-1 ml-1 float-right"
                  href="{{ url_for('admin.show_buggy', username=u.username) }}"
                  ></a>
                -->
              </td>
              <td  class="u-uploaded">
                {% if u.uploaded_at %}
                  {{ u.uploaded_at | servertime }}
                {% else %}
                  <em class="empty-setting">none</em>
                {% endif %}
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if current_user.is_staff %}
    <div class="row">
      <div class="col btn-collection my-4">
        {% if current_user.is_administrator or is_password_change_by_any_staff %}
          <a class="btn btn-outline-secondary btn-admin btn-jump" href="{{ url_for('user.change_password') }}">Change passwords</a>
        {% endif %}
        {% if current_user.is_administrator %}
          <a class="btn btn-outline-secondary btn-admin btn-download" href="{{ url_for('admin.list_users', data_format='csv') }}">Download students CSV</a>
          <a class="btn btn-outline-secondary btn-admin btn-jump" href="{{ url_for('admin.bulk_register') }}">Register new students</a>
          <a class="btn btn-outline-secondary btn-admin btn-jump" href="{{ url_for('admin.new_user') }}">Register new user</a>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>
<div class="modal fade" id="jsonModal" tabindex="-1" role="dialog" aria-labelledby="jsonModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="json-title"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body"><pre id="json-payload"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  const USER_BUGGY_JSON = {
    {% for u in users %}
      {# note: probably better to not use tojson filter on a *string*  #}
      {#       here but it is the safest way to escape quotes maybe?   #}
      {{ u.username | replace("-","_") }}: {{ u.latest_json | tojson }},
    {% endfor %}
    _note: "code in script.js runs if USER_BUGGY_JSON is found"
  };
</script>

{% endblock %}

