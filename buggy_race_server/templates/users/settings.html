{% extends "layout.html" %}
{% block content %}
<div class="container pb-5">
  <div class="row">
    <h1 class="mt-5">Settings for {{ current_user.pretty_username }}</h1>
  </div>
  <div class="row">
    <h2>Your GitHub account</h2>
  </div>

  <div class="row">
    
    {# an increasingly urgent bodge: don't allow insecure unless dev on local:   #}
    {% if not request.is_secure and request.url_root != "http://localhost:5000/" %}
    
        <div class="alert alert-danger w-100" role="alert">
          <p>
            <span class="buggy-warn">WARNING</span>
            You are not using the secure race server!
          </p>
          <p>
            Setting up your GitHub account won't work unless you're logged into
            the secure server.
          </p>
          <p>
            <a href="{{ server_url }}" class="btn btn-warning">Switch to &rarr; {{ server_url }}</a>
          </p>
        </div>

    {% else %}
    
      {% if current_user.is_github_connected() %}
    
        <div class="alert alert-warning w-100" role="alert">
          This buggy racing account is connected to your
          <strong>{{ current_user.github_username }}</strong> GitHub account.
        </div>
      
        {% if current_user.has_course_repository() %}

          <div class="alert w-100" role="alert">
            <p>
              You have forked the Racing Buggy Editor repo into your 
              GitHub account ({{ current_user.github_username }}).
            </p>
             <a href="{{ current_user.course_repository }}" class="btn btn-outline-primary">Go to your Buggy Editor repo &rtri;</a>
             <p class="mt-2">
              Download your vscode workspace so that you can quickly get started editing your buggy race editor!
             </p>
             <a href="/users/vscode-workspace" class="btn btn-outline-primary">VSCode Workspace &rtri;</a>
          </div>

        {% else %}

          <div class="alert alert-primary w-100" role="alert">
            <p>
              You can now <em>fork</em> the Racing Buggy Editor repo. This will
              copy all the files you need into your own GitHub account
              ({{ current_user.github_username }}). It will also add the
              project tasks as <em>issues</em> to that repo.
            </p>
           <!-- TODO: What aria labels does this need? -->
           <form class="form" style="margin:1em" action="{{ url_for('user.setup_course_repository') }}" method="POST">
             <!-- It feels overkill to introduce a form object for an empty form -->
             <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
             <div class="row">
               <button type="submit" class="btn btn-primary">Fork Racing Buggy Editor repo &rtri;</button>
             </div>
           </form>
             <p>
               Forking may take a few moments, so be patient when you click the button!
             </p>
          </div>

        {% endif %}

      
      {% else %}
        <div class="alert alert-secondary w-100" role="alert">
          <p>
            If you connect your GitHub account to this buggy racing server,
            we'll fork the Racing Buggy Editor repo into your own account and
            together with the project tasks (as GitHub issues).
          </p>
          <div class="alert alert-danger w-100" role="alert">
            <p>
              To do this, this buggy racing server needs access to the 
              <code>Repositories</code> and <code>Personal user data</code>
              of your GitHub account. When you click on the button below, GitHub
              will ask you to confirm that you know this server needs such access.
            </p>
          </div>
          <p>
            If you don't have a GitHub account yet, you can create one as part of
            the process when you click this button.
          </p>
          <p>
            <a href="{{ url_for('oauth.github') }}" class="btn btn-primary">Connect your Github account &rtri;</a>
          </p>
          <p>
            Afterwards, expect to receive an email from GitHub alerting you that
            “a third-party OAuth application ({{ env['INSTITUTION_SHORT_NAME']}} Buggy Racing Server) with repo
            and user scopes was recently authorized to access your account.”
          </p>
        </div>
      {% endif %}
    {% endif %}
  </div>
</div>
<div class="container pb-5">
  <div class="row">
    <h2>Your racing server account</h2>
  </div>
  <div class="row">
    <a href="{{ url_for('user.change_password') }}" class="btn btn-outline-secondary">Change password &rtri;</a>
  </div>
  <div class="row">
    <a style="margin-top:1em;" href="{{ url_for('user.set_api_secret') }}" class="btn btn-outline-secondary">Set API secret &rtri;</a>
  </div>
  <div class="row">
    {% if current_user.is_buggy_admin %}
      <a style="margin-top:1em;" href="{{ url_for('admin.admin') }}" class="btn btn-outline-secondary btn-admin"><i class="icon-cog"></i> Admin pages &rtri;</a>
    {% endif %}
  </div>
</div>
{% endblock %}

